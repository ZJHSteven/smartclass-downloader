# 更新日志

## v0.7.0 - Gopeed外部下载 + 列表交互重做（2026-01-11）

### 🚀 下载链路
- 改为通过 Gopeed HTTP API 提交任务（不再使用 GM_download/浏览器下载器）
- 仅使用“无参数 mp4”链接，删除带参数/无参数的降级重试逻辑
- 取消 API 失败时的后台页降级逻辑

### 🧩 UI 交互
- 列表按日期倒序分组展示（每个日期可展开/折叠）
- 下载按钮下沉到列表：支持“整天下载”与“单节下载”
- 信息栏新增 Gopeed/Token 状态与队列并发信息

## v0.6.3 - 日期筛选修复 + 队列下载更稳（2025-12-13）

### 🗓️ 日期筛选
- 修复“手动选择日期后，过几秒又自动跳回最新日期”导致下载日期不对的问题
- 日期解析更鲁棒：兼容 `YYYY/MM/DD`、`YYYY.MM.DD`、`YYYY年MM月DD日` 等格式，避免“最新日期判断错误/漏课”

### 📥 队列下载稳定性
- 队列现在会等待每个下载真正结束（成功/失败/超时）再释放并发计数，减少被浏览器/站点节流导致的“下载不全、过几分钟又继续”
- API 失败降级到后台页时修正 inflight 计数逻辑，避免并发失控

## v0.6.2 - 下载文件命名规则简化（2025-12-13）

### 🏷️ 命名规则
- 文件名改为：`M.D-课程(可简写)-老师-开始小时-结束小时.mp4`（例：`12.12-生理-王栋-8-9.mp4`）
- 去掉年份、教室/地点、分钟等冗余信息，便于快速浏览与排序
- 内置课程简写表：人体功能学→生理、病原与免疫→病原、马克思主义基本原理→马原、医学基础II/Ⅱ→生化、医学术语学2/Ⅱ→英语

## v0.6.1 - UI可读性修复（2025-12-13）

### 🎨 UI
- “使用提示”与“下载状态”区域文字改为**纯白**，提升对比度与可读性

## v0.6 - 令牌抓取 + UI重做（2025-12-13）

### ✅ 关键修复（解决“验证不通过”）
- **不再猜 token 在哪**：改为从页面真实的网络请求（XHR/fetch）中捕获 `/Video/GetVideoInfoDtoByID` 的 `csrkToken`
- **抓到就缓存**：保存到 `localStorage (tm_csrkToken_v2)`，后续 API 直接复用
- **更早运行**：新增 `@run-at document-start`，避免错过页面首次请求

### 🎨 UI 改进
- **整体重写浮层面板**：统一 CSS、提升对比度（亮字 + 深色半透明背景），更易读
- **响应式尺寸**：面板宽度随窗口自适应，避免小屏溢出
- **可折叠**：右上角“折叠/展开”，并记住状态
- **列表/下载状态卡片化**：结构更清晰，信息更集中

## v0.5 - API加速版（2025-12-13）

### 🚀 重大改进
- **秒级下载**：不再打开后台页等待DOM渲染，直接调用 `/Video/GetVideoInfoDtoByID` API获取视频信息
- **立即进入Ctrl+J**：下载任务立即出现在浏览器下载管理器，不再"等很久"
- **提高并发**：从2个提升到3个并发任务，队列处理速度从1.5秒/次优化到1秒/次
- **智能降级**：
  - 先尝试带authKey的mp4链接
  - 失败后自动重试无参数版本
  - API失败时自动降级为原有的后台页模式

### 🔧 优化细节
- **减少日志刷屏**：队列状态只在变化时打印，不再每秒都输出"队列为空"
- **更准确的文件名**：直接从API返回构建文件名，包含教师、教室、时间段等完整信息
- **多段视频支持**：自动处理有多段的课程录播（添加_seg1、_seg2等后缀）

### 📝 技术细节
- 新增 `getVideoInfoByNewId()` - 调用API获取视频信息
- 新增 `mp4FromPlayUri()` - 从PlayFileUri推导mp4地址
- 新增 `buildFilenameFromApi()` - 从API数据构建文件名
- 新增 `gmDownloadWithFallback()` - 带降级重试的下载函数
- 新增 `downloadByApi()` - 通过API直接下载
- 新增 `processQueue()` - 异步队列处理器
- 保留 `openNextFromQueue()` - 作为降级备用方案

### 🎯 使用体验
**之前**：点击下载 → 打开后台页 → 等页面加载 → 等JS初始化 → 等video.js渲染 → 抓到mp4 → 开始下载（可能1分钟）

**现在**：点击下载 → 调用API → 解析mp4 → 立即下载（1-2秒）

---

## v0.4 - 队列版
- 批量队列下载功能
- 后台页自动下载
- 下载进度显示
