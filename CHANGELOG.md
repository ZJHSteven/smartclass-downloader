# 更新日志

## v0.5 - API加速版（2025-12-13）

### 🚀 重大改进
- **秒级下载**：不再打开后台页等待DOM渲染，直接调用 `/Video/GetVideoInfoDtoByID` API获取视频信息
- **立即进入Ctrl+J**：下载任务立即出现在浏览器下载管理器，不再"等很久"
- **提高并发**：从2个提升到3个并发任务，队列处理速度从1.5秒/次优化到1秒/次
- **智能降级**：
  - 先尝试带authKey的mp4链接
  - 失败后自动重试无参数版本
  - API失败时自动降级为原有的后台页模式

### 🔧 优化细节
- **减少日志刷屏**：队列状态只在变化时打印，不再每秒都输出"队列为空"
- **更准确的文件名**：直接从API返回构建文件名，包含教师、教室、时间段等完整信息
- **多段视频支持**：自动处理有多段的课程录播（添加_seg1、_seg2等后缀）

### 📝 技术细节
- 新增 `getVideoInfoByNewId()` - 调用API获取视频信息
- 新增 `mp4FromPlayUri()` - 从PlayFileUri推导mp4地址
- 新增 `buildFilenameFromApi()` - 从API数据构建文件名
- 新增 `gmDownloadWithFallback()` - 带降级重试的下载函数
- 新增 `downloadByApi()` - 通过API直接下载
- 新增 `processQueue()` - 异步队列处理器
- 保留 `openNextFromQueue()` - 作为降级备用方案

### 🎯 使用体验
**之前**：点击下载 → 打开后台页 → 等页面加载 → 等JS初始化 → 等video.js渲染 → 抓到mp4 → 开始下载（可能1分钟）

**现在**：点击下载 → 调用API → 解析mp4 → 立即下载（1-2秒）

---

## v0.4 - 队列版
- 批量队列下载功能
- 后台页自动下载
- 下载进度显示
